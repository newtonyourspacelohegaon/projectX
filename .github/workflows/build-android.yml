# Android APK Build & Release Workflow
# Triggers on push to main branch or manual dispatch
# Builds APK using EAS and uploads to GitHub Releases

name: Build & Release Android APK

on:
  push:
    branches: [main]
    paths-ignore:
      - 'backend/**'
      - 'README.md'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version name (e.g., 1.0.2)'
        required: true
        default: '1.0.2'
      force_update:
        description: 'Force update (true/false)'
        required: false
        default: 'false'

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”§ Setup EAS CLI
        run: npm install -g eas-cli

      - name: ðŸ” Setup Expo credentials
        run: eas whoami

      - name: ðŸ“± Build Android APK
        run: eas build -p android --profile production --non-interactive --no-wait
        id: build

      - name: â³ Wait for build to complete
        run: |
          echo "Waiting for EAS build to complete..."
          BUILD_ID=$(eas build:list --platform android --limit 1 --json | jq -r '.[0].id')
          echo "Build ID: $BUILD_ID"
          
          while true; do
            STATUS=$(eas build:view $BUILD_ID --json | jq -r '.status')
            echo "Build status: $STATUS"
            
            if [ "$STATUS" = "FINISHED" ]; then
              echo "Build completed successfully!"
              break
            elif [ "$STATUS" = "ERRORED" ] || [ "$STATUS" = "CANCELED" ]; then
              echo "Build failed with status: $STATUS"
              exit 1
            fi
            
            sleep 60
          done

      - name: ðŸ“¥ Download APK from EAS
        run: |
          BUILD_ID=$(eas build:list --platform android --limit 1 --json | jq -r '.[0].id')
          APK_URL=$(eas build:view $BUILD_ID --json | jq -r '.artifacts.buildUrl')
          echo "APK URL: $APK_URL"
          curl -L -o app-release.apk "$APK_URL"
          echo "APK_URL=$APK_URL" >> $GITHUB_ENV

      - name: ðŸ“ Get version info
        id: version
        run: |
          VERSION_NAME=$(jq -r '.expo.version' app.json)
          VERSION_CODE=$(jq -r '.expo.android.versionCode' app.json)
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION_NAME (Code: $VERSION_CODE)"

      - name: ðŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION_NAME }}
          name: Release v${{ steps.version.outputs.VERSION_NAME }}
          body: |
            ## Vybe v${{ steps.version.outputs.VERSION_NAME }}
            
            **Version Code:** ${{ steps.version.outputs.VERSION_CODE }}
            **Build Date:** ${{ github.event.head_commit.timestamp }}
            
            ### What's New
            - Latest features and bug fixes
            
            ### Download
            Download the APK file below and install on your Android device.
          files: app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¤ Output APK URL
        run: |
          echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ steps.version.outputs.VERSION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**APK URL:** https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION_NAME }}/app-release.apk" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Update your backend with this URL!" >> $GITHUB_STEP_SUMMARY
