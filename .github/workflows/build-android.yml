# Android APK Build & Release Workflow
# Triggers on push to main branch or manual dispatch
# Builds APK using EAS and uploads to GitHub Releases

name: Build & Release Android APK

on:
  push:
    branches: [main]
    paths-ignore:
      - 'backend/**'
      - 'README.md'
      - '.gitignore'
  workflow_dispatch:

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”‘ Check EXPO_TOKEN
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "âŒ ERROR: EXPO_TOKEN secret is not set!"
            echo "Please add your Expo token to GitHub Secrets:"
            echo "1. Go to https://expo.dev/settings/access-tokens"
            echo "2. Create a new token"
            echo "3. Add to repo: Settings â†’ Secrets â†’ Actions â†’ EXPO_TOKEN"
            exit 1
          fi
          echo "âœ… EXPO_TOKEN is set"

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”§ Setup EAS CLI
        run: npm install -g eas-cli

      - name: ðŸ” Verify Expo login
        run: |
          echo "Checking Expo authentication..."
          eas whoami || { echo "âŒ Failed to authenticate with Expo"; exit 1; }

      - name: ðŸ“± Build Android APK
        id: build
        run: |
          echo "Starting EAS build..."
          BUILD_OUTPUT=$(eas build -p android --profile production --non-interactive 2>&1) || true
          echo "$BUILD_OUTPUT"
          
          # Extract build URL from output
          BUILD_URL=$(echo "$BUILD_OUTPUT" | grep -o 'https://expo.dev/accounts/[^[:space:]]*' | head -1)
          
          if [ -n "$BUILD_URL" ]; then
            echo "BUILD_URL=$BUILD_URL" >> $GITHUB_OUTPUT
            echo "âœ… Build started: $BUILD_URL"
          else
            echo "âŒ Could not extract build URL"
            exit 1
          fi

      - name: â³ Wait for build and download APK
        run: |
          echo "Waiting for EAS build to complete (this may take 15-30 minutes)..."
          
          # Use EAS CLI to wait for build
          for i in {1..60}; do
            echo "Checking build status... (attempt $i/60)"
            
            BUILD_JSON=$(eas build:list --platform android --limit 1 --json 2>/dev/null) || continue
            
            STATUS=$(echo "$BUILD_JSON" | jq -r '.[0].status' 2>/dev/null) || continue
            echo "Status: $STATUS"
            
            if [ "$STATUS" = "FINISHED" ]; then
              APK_URL=$(echo "$BUILD_JSON" | jq -r '.[0].artifacts.buildUrl' 2>/dev/null)
              echo "âœ… Build completed!"
              echo "APK_URL=$APK_URL" >> $GITHUB_ENV
              
              echo "Downloading APK..."
              curl -L -o app-release.apk "$APK_URL"
              echo "âœ… APK downloaded successfully!"
              exit 0
            elif [ "$STATUS" = "ERRORED" ] || [ "$STATUS" = "CANCELED" ]; then
              echo "âŒ Build failed with status: $STATUS"
              exit 1
            fi
            
            sleep 30
          done
          
          echo "âŒ Build timed out after 30 minutes"
          exit 1

      - name: ðŸ“ Get version info
        id: version
        run: |
          VERSION_NAME=$(jq -r '.expo.version' app.json)
          VERSION_CODE=$(jq -r '.expo.android.versionCode // 1' app.json)
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION_NAME (Code: $VERSION_CODE)"

      - name: ðŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION_NAME }}
          name: Release v${{ steps.version.outputs.VERSION_NAME }}
          body: |
            ## Vybe v${{ steps.version.outputs.VERSION_NAME }}
            
            **Version Code:** ${{ steps.version.outputs.VERSION_CODE }}
            **Build Date:** ${{ github.event.head_commit.timestamp }}
            
            ### What's New
            - Latest features and bug fixes
            
            ### Download
            Download the APK file below and install on your Android device.
          files: app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¤ Output APK URL
        run: |
          echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ steps.version.outputs.VERSION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**APK URL:** https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION_NAME }}/app-release.apk" >> $GITHUB_STEP_SUMMARY

