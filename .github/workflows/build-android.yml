# Native Build Workflow - Only for APK releases
# Triggers on version bump or manual dispatch
# Non-blocking: starts build and exits (check Expo dashboard for status)

name: Build Android APK (Native)

on:
  push:
    branches: [main]
    paths:
      - 'app.json'
      - 'eas.json'
      - 'android/**'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release after build'
        required: false
        type: boolean
        default: true

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  # Job 1: Start build (fast, non-blocking)
  start-build:
    name: Start EAS Build
    runs-on: ubuntu-latest
    outputs:
      build_id: ${{ steps.build.outputs.build_id }}
      version: ${{ steps.version.outputs.version }}
      version_code: ${{ steps.version.outputs.version_code }}
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîë Check EXPO_TOKEN
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "‚ùå EXPO_TOKEN not set. Add it to GitHub Secrets."
            exit 1
          fi

      - name: üìù Get version info
        id: version
        run: |
          VERSION=$(jq -r '.expo.version' app.json)
          VERSION_CODE=$(jq -r '.expo.android.versionCode // 1' app.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION (Code: $VERSION_CODE)"

      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Cache Expo
        uses: actions/cache@v4
        with:
          path: |
            ~/.expo
            ~/.eas
          key: expo-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîß Setup EAS CLI
        run: npm install -g eas-cli

      - name: üîê Verify Expo login
        run: eas whoami

      - name: üì± Start EAS Build (non-blocking)
        id: build
        run: |
          echo "Starting EAS build..."
          
          # Start build and capture JSON output
          BUILD_JSON=$(eas build -p android --profile production --non-interactive --json --no-wait 2>&1) || true
          
          echo "$BUILD_JSON"
          
          # Extract build ID from JSON
          BUILD_ID=$(echo "$BUILD_JSON" | jq -r '.[0].id // empty' 2>/dev/null)
          
          if [ -n "$BUILD_ID" ]; then
            echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
            echo "‚úÖ Build started with ID: $BUILD_ID"
            echo "üîó Monitor at: https://expo.dev/accounts/newtonyourspacelohegaon/builds/$BUILD_ID"
          else
            # Fallback: try to get latest build
            echo "Checking for latest build..."
            sleep 5
            BUILD_ID=$(eas build:list --platform android --limit 1 --json 2>/dev/null | jq -r '.[0].id // empty')
            
            if [ -n "$BUILD_ID" ]; then
              echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
              echo "‚úÖ Found build ID: $BUILD_ID"
            else
              echo "‚ùå Could not get build ID"
              exit 1
            fi
          fi

      - name: üìù Build Summary
        run: |
          echo "## üöÄ Build Started!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | v${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version Code** | ${{ steps.version.outputs.version_code }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build ID** | ${{ steps.build.outputs.build_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚è≥ **Build will complete in ~15-25 minutes**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Monitor progress: https://expo.dev/builds" >> $GITHUB_STEP_SUMMARY

  # Job 2: Wait for build and create release (separate job)
  wait-and-release:
    name: Wait & Release
    needs: start-build
    if: ${{ github.event.inputs.create_release != 'false' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß Setup EAS CLI
        run: npm install -g eas-cli

      - name: ‚è≥ Wait for build to complete
        id: wait
        run: |
          BUILD_ID="${{ needs.start-build.outputs.build_id }}"
          echo "Waiting for build $BUILD_ID to complete..."
          
          for i in {1..60}; do
            echo "Checking status... (attempt $i/60)"
            
            BUILD_JSON=$(eas build:view "$BUILD_ID" --json 2>/dev/null) || { sleep 30; continue; }
            STATUS=$(echo "$BUILD_JSON" | jq -r '.status')
            
            echo "Status: $STATUS"
            
            if [ "$STATUS" = "FINISHED" ]; then
              APK_URL=$(echo "$BUILD_JSON" | jq -r '.artifacts.buildUrl')
              echo "apk_url=$APK_URL" >> $GITHUB_OUTPUT
              echo "‚úÖ Build completed!"
              exit 0
            elif [ "$STATUS" = "ERRORED" ] || [ "$STATUS" = "CANCELED" ]; then
              echo "‚ùå Build failed: $STATUS"
              exit 1
            fi
            
            sleep 30
          done
          
          echo "‚ùå Timeout waiting for build"
          exit 1
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: üì• Download APK
        run: |
          curl -L -o app-release.apk "${{ steps.wait.outputs.apk_url }}"
          ls -la app-release.apk

      - name: üè∑Ô∏è Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.start-build.outputs.version }}
          name: Release v${{ needs.start-build.outputs.version }}
          body: |
            ## Vybe v${{ needs.start-build.outputs.version }}
            
            **Version Code:** ${{ needs.start-build.outputs.version_code }}
            **Build ID:** ${{ needs.start-build.outputs.build_id }}
            
            ### Download
            Download the APK file below and install on your Android device.
          files: app-release.apk
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
