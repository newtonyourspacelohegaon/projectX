# OTA Update Workflow (FAST - seconds, not minutes!)
# For JavaScript/TypeScript changes only - no native rebuild needed

name: OTA Update (Fast Deploy)

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - 'components/**'
      - 'utils/**'
      - 'assets/**'
      - '!android/**'
      - '!ios/**'
      - '!app.json'
      - '!eas.json'
  workflow_dispatch:
    inputs:
      message:
        description: 'Update message'
        required: false
        default: 'Bug fixes and improvements'

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  ota-update:
    name: Publish OTA Update
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”‘ Check EXPO_TOKEN
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "âŒ EXPO_TOKEN not set"
            exit 1
          fi

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Cache Expo
        uses: actions/cache@v4
        with:
          path: |
            ~/.expo
            ~/.eas
          key: expo-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”§ Setup EAS CLI
        run: npm install -g eas-cli

      - name: ðŸš€ Publish OTA Update
        run: |
          echo "Publishing OTA update..."
          eas update --branch production --message "${{ github.event.inputs.message || 'Bug fixes and improvements' }}" --non-interactive
          echo "âœ… OTA update published!"

      - name: ðŸ“ Summary
        run: |
          echo "## âš¡ OTA Update Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Users will receive this update automatically within 24 hours." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Message:** ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
